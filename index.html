<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Z-Hospital : Wave Survival</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 10px; height: 10px;
            border: 2px solid rgba(255, 0, 0, 0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: #ff3333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; z-index: 20; text-align: center;
        }
        #ui {
            position: absolute; bottom: 20px; left: 20px;
            color: white; font-size: 20px; text-shadow: 1px 1px #000;
            background: rgba(0,0,0,0.7); padding: 15px; border-left: 5px solid #ff0000;
        }
        #wave-announcement {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            color: #ff0000; font-size: 40px; font-weight: bold;
            display: none; pointer-events: none; text-shadow: 0 0 10px #000;
        }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="wave-announcement">VAGUE 1</div>

    <div id="instructions">
        <h1 style="font-size: 40px;">HÔPITAL : SURVIE PAR VAGUES</h1>
        <p>CLIQUEZ POUR ENTRER</p>
        <p style="color: #aaa; font-size: 0.8em;">(ZQSD = Bouger | SOURIS = Viser | CLIC = Tirer)</p>
    </div>

    <div id="ui">
        VAGUE : <span id="wave-num">1</span><br>
        ZOMBIES RESTANTS : <span id="zombie-count">0</span><br>
        SCORE TOTAL : <span id="score">0</span>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';
        import { PointerLockControls } from 'https://cdn.skypack.dev/three@0.136.0/examples/jsm/controls/PointerLockControls.js';

        // --- 1. CONFIGURATION ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050805, 0.04);
        scene.background = new THREE.Color(0x050805);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.y = 1.7;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- 2. LAMPE TORCHE (LUMINOSITÉ AUGMENTÉE) ---
        const ambientLight = new THREE.AmbientLight(0x404040, 0.2);
        scene.add(ambientLight);

        // Intensité passée de 1 à 3 pour y voir beaucoup mieux
        const flashLight = new THREE.SpotLight(0xffffff, 3, 50, Math.PI/4, 0.4, 1);
        flashLight.castShadow = true;
        scene.add(flashLight);
        scene.add(flashLight.target);

        // --- 3. MAP (HÔPITAL) ---
        const floorGeo = new THREE.PlaneGeometry(200, 200);
        const floorMat = new THREE.MeshPhongMaterial({ color: 0x222222 });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);
        scene.add(new THREE.GridHelper(200, 40, 0x000000, 0x113311));

        const wallMat = new THREE.MeshPhongMaterial({ color: 0x334433 });
        for(let i = 0; i < 50; i++) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(3, 8, 3), wallMat);
            let x = (Math.random() - 0.5) * 140;
            let z = (Math.random() - 0.5) * 140;
            if (Math.abs(x) < 15 && Math.abs(z) < 15) x += 30;
            wall.position.set(x, 4, z);
            wall.castShadow = true; wall.receiveShadow = true;
            scene.add(wall);
        }

        // --- 4. SYSTÈME DE VAGUES ET ZOMBIES ---
        let wave = 0;
        let zombiesToSpawn = 0;
        let score = 0;
        const zombies = [];
        const zombieMaterial = new THREE.MeshLambertMaterial({ color: 0x224422 });

        function createZombie() {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.2, 0.4), zombieMaterial);
            body.position.y = 0.6;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), zombieMaterial);
            head.position.y = 1.4;
            const arm = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.15, 0.7), zombieMaterial);
            arm.position.set(0.3, 1.1, 0.35);
            const arm2 = arm.clone(); arm2.position.x = -0.3;
            group.add(body, head, arm, arm2);
            return group;
        }

        function startNextWave() {
            wave++;
            zombiesToSpawn = wave * 5; // +5 zombies par vague
            document.getElementById('wave-num').innerText = wave;
            
            // Annonce visuelle
            const msg = document.getElementById('wave-announcement');
            msg.innerText = "VAGUE " + wave;
            msg.style.display = "block";
            setTimeout(() => { msg.style.display = "none"; }, 3000);

            // Apparition progressive
            const spawnInterval = setInterval(() => {
                if (zombiesToSpawn > 0) {
                    spawnZombie();
                    zombiesToSpawn--;
                    updateUI();
                } else {
                    clearInterval(spawnInterval);
                }
            }, 1000);
        }

        function spawnZombie() {
            const z = createZombie();
            const angle = Math.random() * Math.PI * 2;
            const dist = 45;
            z.position.set(Math.cos(angle)*dist, 0, Math.sin(angle)*dist);
            scene.add(z);
            zombies.push({ mesh: z, hp: 1, speed: 0.03 + (wave * 0.005) });
        }

        function updateUI() {
            document.getElementById('zombie-count').innerText = zombies.length + zombiesToSpawn;
            document.getElementById('score').innerText = score;
        }

        // --- 5. CONTRÔLES ET TIR ---
        const controls = new PointerLockControls(camera, document.body);
        document.getElementById('instructions').addEventListener('click', () => controls.lock());
        
        window.addEventListener('mousedown', () => {
            if(!controls.isLocked) return;
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
            
            let targetMeshes = [];
            zombies.forEach(z => targetMeshes.push(...z.mesh.children));
            
            const intersects = raycaster.intersectObjects(targetMeshes);
            if(intersects.length > 0) {
                const zombieGroup = intersects[0].object.parent;
                scene.remove(zombieGroup);
                const idx = zombies.findIndex(z => z.mesh === zombieGroup);
                if(idx > -1) zombies.splice(idx, 1);
                score += 10;
                updateUI();
                
                // Si vague finie
                if(zombies.length === 0 && zombiesToSpawn === 0) {
                    setTimeout(startNextWave, 2000);
                }
            }
        });

        // --- 6. BOUCLE DE JEU ---
        let moveF = false, moveB = false, moveL = false, moveR = false;
        document.addEventListener('keydown', (e) => {
            if(e.code === 'KeyW' || e.code === 'KeyZ') moveF = true;
            if(e.code === 'KeyS') moveB = true;
            if(e.code === 'KeyA' || e.code === 'KeyQ') moveL = true;
            if(e.code === 'KeyD') moveR = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.code === 'KeyW' || e.code === 'KeyZ') moveF = false;
            if(e.code === 'KeyS') moveB = false;
            if(e.code === 'KeyA' || e.code === 'KeyQ') moveL = false;
            if(e.code === 'KeyD') moveR = false;
        });

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked) {
                // Mouvement joueur
                if(moveF) controls.moveForward(0.12);
                if(moveB) controls.moveForward(-0.1);
                if(moveL) controls.moveRight(-0.08);
                if(moveR) controls.moveRight(0.08);

                // Lampe
                flashLight.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                flashLight.target.position.copy(camera.position).add(dir);

                // Zombies
                zombies.forEach(z => {
                    z.mesh.lookAt(camera.position.x, 0, camera.position.z);
                    const d = new THREE.Vector3().subVectors(camera.position, z.mesh.position).setY(0).normalize();
                    z.mesh.position.add(d.multiplyScalar(z.speed));
                    
                    if(z.mesh.position.distanceTo(camera.position) < 1.4) {
                        alert("VAGUE " + wave + " ÉCHOUÉE. Score : " + score);
                        location.reload();
                    }
                });
            }
            renderer.render(scene, camera);
        }

        startNextWave();
        animate();
    </script>
</body>
</html>
