<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Z-Hospital : Custom Map Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 12px; height: 12px;
            border: 2px solid red; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        /* Interface Accueil & ParamÃ¨tres */
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: #ff3333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; text-align: center;
        }
        .box { background: rgba(30, 30, 30, 0.9); border: 2px solid #555; padding: 20px; border-radius: 8px; width: 350px; color: white; }
        .shop-item { background: #222; margin: 8px 0; padding: 8px; border: 1px solid #444; cursor: pointer; text-align: left; font-size: 13px; }
        .shop-item:hover { border-color: #f00; }
        
        /* UI de Jeu */
        #ui-left { position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 15px; border-left: 5px solid #f00; z-index: 50; }
        #ui-right { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-right: 5px solid #0f0; z-index: 50; width: 200px; }
        .hp-bar-bg { width: 100%; height: 15px; background: #333; margin-top: 5px; }
        #hp-bar-fill { width: 100%; height: 100%; background: #0f0; transition: 0.2s; }
        #minimap-container { position: absolute; top: 20px; left: 20px; border: 2px solid #555; background: rgba(0,10,0,0.8); border-radius: 50%; overflow: hidden; z-index: 50; }
        #status-map { color: #0f0; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="minimap-container"><canvas id="minimap" width="150" height="150"></canvas></div>

    <div id="instructions">
        <h1 style="margin: 0;">Z-HOSPITAL 3D</h1>
        <div id="status-map">Chargement du modÃ¨le...</div>
        
        <div class="box">
            <h3 style="margin-top: 0;">RÃ‰GLAGES & MAGASIN</h3>
            <label>LUMINOSITÃ‰ LAMPE</label>
            <input type="range" id="lightSlider" min="10" max="300" value="100" style="width: 100%; accent-color: red;">
            
            <div id="shop-list" style="margin-top: 15px;">
                </div>
        </div>

        <button id="start-btn" style="margin-top: 20px; padding: 10px 30px; cursor: pointer; background: none; color: #f00; border: 2px solid #f00; font-family: inherit; font-size: 20px;">LANCER</button>
    </div>

    <div id="ui-left">
        VAGUE : <span id="wave-val">1</span> | PIÃˆCES : <span id="coin-val">0</span><br>
        ARME : <span id="weapon-name">Pistolet</span>
    </div>

    <div id="ui-right">
        <span style="font-size: 14px;">SANTÃ‰ DU SURVIVANT</span>
        <div class="hp-bar-bg"><div id="hp-bar-fill"></div></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "fflate": "https://unpkg.com/fflate@0.8.0/lib/browser.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { USDZLoader } from 'three/addons/loaders/USDZLoader.js';

        // --- VARIABLES DE JEU ---
        let player = { hp: 100, coins: 0, score: 0, wave: 0, weaponDmg: 1 };
        let zombies = [];
        const weapons = [
            { name: "Pistolet", dmg: 1, price: 0, owned: true },
            { name: "Fusil Pro", dmg: 3, price: 100, owned: false },
            { name: "Laser", dmg: 20, price: 500, owned: false }
        ];

        // --- SCÃˆNE 3D ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020502, 0.03);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.8, 5); // Position de dÃ©part

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const flashLight = new THREE.SpotLight(0xffffff, 100, 150, Math.PI/4, 0.3, 1);
        flashLight.castShadow = true;
        scene.add(flashLight, flashLight.target, new THREE.AmbientLight(0xffffff, 0.1));

        // --- CHARGEMENT DE LA MAP ---
        const loader = new USDZLoader();
        const statusText = document.getElementById('status-map');

        loader.load('Abandoned_Hospital_part_one.usdz', (usdz) => {
            // AJUSTEMENT AUTOMATIQUE : 
            // On agrandit souvent les USDZ car ils sont petits
            usdz.scale.set(10, 10, 10); 
            usdz.position.set(0, 0, 0);
            
            // On force les ombres sur le modÃ¨le
            usdz.traverse(node => { if(node.isMesh) { node.castShadow = true; node.receiveShadow = true; } });
            
            scene.add(usdz);
            statusText.innerText = "MAP CHARGÃ‰E ET PRÃŠTE !";
        }, undefined, (err) => {
            statusText.innerText = "ERREUR FICHIER : VÃ©rifiez le nom du fichier sur GitHub";
            statusText.style.color = "red";
        });

        // --- SYSTÃˆME DE VAGUES ---
        function spawnWave() {
            player.wave++;
            document.getElementById('wave-val').innerText = player.wave;
            for(let i=0; i < (5 + player.wave * 2); i++) {
                const zGroup = new THREE.Group();
                const mat = new THREE.MeshLambertMaterial({ color: 0x224422 });
                const b = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.2, 0.4), mat); b.position.y = 0.6;
                const h = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), mat); h.position.y = 1.4;
                zGroup.add(b, h);
                
                const ang = Math.random() * Math.PI * 2;
                zGroup.position.set(Math.cos(ang)*30, 0, Math.sin(ang)*30);
                scene.add(zGroup);
                zombies.push({ mesh: zGroup, hp: 2, speed: 0.04 + (player.wave * 0.005) });
            }
        }

        // --- MAGASIN & UI ---
        function updateShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            weapons.forEach(w => {
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.innerHTML = `${w.name} (DÃ©gÃ¢ts: ${w.dmg}) - ðŸ’° ${w.owned ? 'POSSÃ‰DÃ‰' : w.price}`;
                item.onclick = () => {
                    if(w.owned) { player.weaponDmg = w.dmg; document.getElementById('weapon-name').innerText = w.name; }
                    else if(player.coins >= w.price) { player.coins -= w.price; w.owned = true; updateShop(); }
                };
                list.appendChild(item);
            });
            document.getElementById('coin-val').innerText = player.coins;
        }

        // --- CONTRÃ”LES ---
        const controls = new PointerLockControls(camera, document.body);
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('instructions').style.display = 'none';
            controls.lock();
            if(player.wave === 0) spawnWave();
        };
        document.getElementById('lightSlider').oninput = (e) => flashLight.intensity = e.target.value;

        window.addEventListener('mousedown', () => {
            if(!controls.isLocked) return;
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(zombies.map(z => z.mesh), true);
            if(hits.length > 0) {
                let obj = hits[0].object;
                while(obj.parent && obj.type !== 'Group') obj = obj.parent;
                const zIdx = zombies.findIndex(z => z.mesh === obj);
                if(zIdx !== -1) {
                    zombies[zIdx].hp -= player.weaponDmg;
                    if(zombies[zIdx].hp <= 0) {
                        scene.remove(zombies[zIdx].mesh);
                        zombies.splice(zIdx, 1);
                        player.coins += 10; updateShop();
                        if(zombies.length === 0) setTimeout(spawnWave, 2000);
                    }
                }
            }
        });

        // --- MINI-MAP ---
        const mCtx = document.getElementById('minimap').getContext('2d');
        function drawMap() {
            mCtx.fillStyle = 'rgba(0,10,0,0.5)'; mCtx.fillRect(0,0,150,150);
            mCtx.fillStyle = '#0f0'; mCtx.fillRect(75 + camera.position.x/2, 75 + camera.position.z/2, 4, 4);
            mCtx.fillStyle = '#f00'; zombies.forEach(z => mCtx.fillRect(75 + z.mesh.position.x/2, 75 + z.mesh.position.z/2, 3, 3));
        }

        // --- BOUCLE FINALE ---
        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked) {
                if(keys['KeyW'] || keys['KeyZ']) controls.moveForward(0.15);
                if(keys['KeyS']) controls.moveForward(-0.15);
                if(keys['KeyA'] || keys['KeyQ']) controls.moveRight(-0.15);
                if(keys['KeyD']) controls.moveRight(0.15);

                flashLight.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                flashLight.target.position.copy(camera.position).add(dir);

                zombies.forEach(z => {
                    z.mesh.lookAt(camera.position.x, 0, camera.position.z);
                    const v = new THREE.Vector3().subVectors(camera.position, z.mesh.position).setY(0).normalize();
                    z.mesh.position.add(v.multiplyScalar(z.speed));
                    if(z.mesh.position.distanceTo(camera.position) < 1.5) {
                        player.hp -= 0.5; document.getElementById('hp-bar-fill').style.width = player.hp + "%";
                        if(player.hp <= 0) location.reload();
                    }
                });
                drawMap();
            }
            renderer.render(scene, camera);
        }
        updateShop(); animate();
    </script>
</body>
</html>
