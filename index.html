<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Z-Hospital : Auto-Vision</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Courier New', monospace; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            border: 2px solid red; border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 10;
        }
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: #ff3333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; text-align: center;
        }
        #status-log { color: #0f0; background: #000; padding: 10px; font-size: 12px; margin-bottom: 20px; border: 1px solid #333; }
        #ui { position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.8); padding: 10px; border-left: 4px solid red; }
    </style>
</head>
<body>

    <div id="crosshair"></div>
    <div id="instructions">
        <h1>SYSTÈME DE SURVIE 3D</h1>
        <div id="status-log">Initialisation...</div>
        <p>CLIQUEZ POUR LANCER</p>
        <div style="background:#222; padding:10px; border:1px solid #444;">
            <label>PUISSANCE LAMPE</label><br>
            <input type="range" id="lightSlider" min="10" max="500" value="150" style="width:200px; accent-color:red;">
        </div>
    </div>

    <div id="ui">VAGUE : <span id="wv">0</span> | SCORE : <span id="sc">0</span></div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "fflate": "https://unpkg.com/fflate@0.8.0/lib/browser.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { USDZLoader } from 'three/addons/loaders/USDZLoader.js';

        const log = document.getElementById('status-log');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Lumières fortes pour le debug
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);
        const flashLight = new THREE.SpotLight(0xffffff, 150, 500, Math.PI/4);
        scene.add(flashLight, flashLight.target);

        // Chargement du modèle
        const loader = new USDZLoader();
        loader.load('Abandoned_Hospital_part_one.usdz', (model) => {
            log.innerText = "Modèle reçu. Analyse de la taille...";
            
            // --- SOLUTION AUTO-AJUSTEMENT ---
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());

            // On centre le modèle
            model.position.x += (model.position.x - center.x);
            model.position.y += (model.position.y - center.y);
            model.position.z += (model.position.z - center.z);

            // On le met au niveau du sol (Y=0)
            model.position.y = 0;

            // On l'agrandit s'il est minuscule (fréquent avec USDZ)
            const maxDim = Math.max(size.x, size.y, size.z);
            if (maxDim < 1) {
                model.scale.setScalar(100);
                log.innerText = "Map minuscule détectée : Agrandie x100.";
            } else if (maxDim > 5000) {
                model.scale.setScalar(0.01);
                log.innerText = "Map géante détectée : Réduite x0.01.";
            } else {
                log.innerText = "Taille de map correcte.";
            }

            scene.add(model);
            log.innerText += " - PRÊT !";
            log.style.color = "lime";
            
        }, (xhr) => {
            log.innerText = "Téléchargement : " + Math.round(xhr.loaded / xhr.total * 100) + "%";
        }, (err) => {
            log.innerText = "ERREUR : Fichier introuvable.";
            log.style.color = "red";
        });

        // Contrôles
        const controls = new PointerLockControls(camera, document.body);
        document.getElementById('instructions').onclick = () => {
            controls.lock();
            document.getElementById('instructions').style.display = 'none';
        };
        
        document.getElementById('lightSlider').oninput = (e) => flashLight.intensity = e.target.value;

        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked) {
                if(keys['KeyW'] || keys['KeyZ']) controls.moveForward(0.2);
                if(keys['KeyS']) controls.moveForward(-0.2);
                if(keys['KeyA'] || keys['KeyQ']) controls.moveRight(-0.2);
                if(keys['KeyD']) controls.moveRight(0.2);

                flashLight.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                flashLight.target.position.copy(camera.position).add(dir);
            }
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
