<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Z-Hospital : Real Map Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 12px; height: 12px;
            border: 2px solid rgba(255, 0, 0, 0.9); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none; z-index: 10;
        }
        #instructions {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: #ff3333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; text-align: center;
        }
        .box { background: rgba(30, 30, 30, 0.9); border: 2px solid #555; padding: 15px; border-radius: 8px; width: 300px; color: white; }
        #start-prompt { margin-top: 20px; font-size: 24px; cursor: pointer; padding: 10px 40px; border: 2px solid #ff3333; background: none; color: #ff3333; font-family: inherit; }
        #ui-left { position: absolute; bottom: 20px; left: 20px; color: white; font-size: 16px; background: rgba(0,0,0,0.8); padding: 15px; border-left: 5px solid #ff0000; z-index: 50; }
        #ui-right { position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-right: 5px solid #00ff00; z-index: 50; width: 220px; }
        .hp-container { width: 100%; height: 15px; background: #333; margin-top: 5px; }
        #hp-bar { width: 100%; height: 100%; background: #00ff00; transition: width 0.2s; }
        #loading-text { color: yellow; font-weight: bold; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <div id="crosshair"></div>

    <div id="instructions">
        <h1 style="font-size: 35px; margin: 0;">Z-HOSPITAL : REAL MAP</h1>
        <div id="loading-text">CHARGEMENT DE LA MAP 3D...</div>
        
        <div class="box">
            <h3 style="margin-top: 0;">PARAMÈTRES</h3>
            <label style="font-size: 12px;">LUMINOSITÉ LAMPE</label>
            <input type="range" id="lightSlider" min="5" max="300" value="100" style="width: 100%; accent-color: #f00;">
        </div>

        <button id="start-prompt">LANCER L'INTERVENTION</button>
    </div>

    <div id="ui-left">
        VAGUE : <span id="wave-num">1</span> | PIÈCES : <span id="ui-coins">0</span><br>
        ARME : <span id="ui-weapon">Pistolet</span>
    </div>

    <div id="ui-right">
        <span style="color: white; font-size: 14px;">SANTÉ</span>
        <div class="hp-container"><div id="hp-bar"></div></div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { USDZLoader } from 'three/addons/loaders/USDZLoader.js';

        // --- ÉTAT DU JEU ---
        let player = { hp: 100, coins: 0, wave: 0 };
        let zombies = [];
        let hospitalModel;

        // --- INITIALISATION 3D ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020502, 0.05);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- LUMIÈRES ---
        const flashLight = new THREE.SpotLight(0xffffff, 100, 150, Math.PI/4, 0.3, 1);
        flashLight.castShadow = true;
        scene.add(flashLight, flashLight.target);
        scene.add(new THREE.AmbientLight(0xffffff, 0.05));

        // --- CHARGEMENT DE TA MAP (USDZ) ---
        const loader = new USDZLoader();
        const loadingText = document.getElementById('loading-text');
        loadingText.style.display = 'block';

        loader.load(
            'Abandoned_Hospital_part_one.usdz', // Nom exact de ton fichier
            function ( usdz ) {
                hospitalModel = usdz;
                hospitalModel.scale.set(1, 1, 1); // À ajuster selon la taille du modèle
                hospitalModel.position.set(0, 0, 0);
                
                // Activer les ombres sur le modèle chargé
                hospitalModel.traverse( function ( child ) {
                    if ( child.isMesh ) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                } );

                scene.add( hospitalModel );
                loadingText.style.display = 'none';
                console.log("Map chargée avec succès !");
            },
            undefined,
            function ( error ) {
                console.error( "Erreur lors du chargement du modèle : ", error );
                loadingText.innerText = "ERREUR DE CHARGEMENT DU FICHIER .USDZ";
            }
        );

        // --- SOL DE SÉCURITÉ (Au cas où la map est trouée) ---
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshPhongMaterial({ color: 0x111111 }));
        floor.rotation.x = -Math.PI/2; floor.receiveShadow = true; 
        scene.add(floor);

        // --- GESTION ZOMBIES ---
        function createZModel() {
            const g = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x224422 });
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.6, 1.2, 0.4), mat); b.position.y = 0.6;
            const h = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), mat); h.position.y = 1.4;
            g.add(b, h); return g;
        }

        function spawnWave() {
            player.wave++; document.getElementById('wave-num').innerText = player.wave;
            for(let i=0; i < (5 + player.wave * 2); i++) {
                const z = createZModel();
                const ang = Math.random() * Math.PI * 2;
                z.position.set(Math.cos(ang)*40, 0, Math.sin(ang)*40);
                scene.add(z);
                zombies.push({ mesh: z, hp: 2, speed: 0.04 + (player.wave * 0.005) });
            }
        }

        // --- CONTROLES ---
        const controls = new PointerLockControls(camera, document.body);
        document.getElementById('start-prompt').onclick = () => { 
            document.getElementById('instructions').style.display = 'none'; 
            controls.lock(); 
        };
        document.getElementById('lightSlider').oninput = (e) => flashLight.intensity = e.target.value;

        // --- TIR ---
        window.addEventListener('mousedown', () => {
            if(!controls.isLocked) return;
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(zombies.map(z => z.mesh), true);
            if(hits.length > 0) {
                let obj = hits[0].object;
                while(obj.parent && obj.type !== 'Group') obj = obj.parent;
                const zIndex = zombies.findIndex(z => z.mesh === obj);
                if(zIndex !== -1) {
                    scene.remove(zombies[zIndex].mesh);
                    zombies.splice(zIndex, 1);
                    if(zombies.length === 0) spawnWave();
                }
            }
        });

        // --- BOUCLE ANIMATION ---
        let keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            if(controls.isLocked) {
                // Déplacement
                if(keys['KeyW'] || keys['KeyZ']) controls.moveForward(0.15);
                if(keys['KeyS']) controls.moveForward(-0.15);
                if(keys['KeyA'] || keys['KeyQ']) controls.moveRight(-0.15);
                if(keys['KeyD']) controls.moveRight(0.15);

                // Lampe
                flashLight.position.copy(camera.position);
                const dir = new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion);
                flashLight.target.position.copy(camera.position).add(dir);

                // IA Zombies
                zombies.forEach(z => {
                    z.mesh.lookAt(camera.position.x, 0, camera.position.z);
                    let v = new THREE.Vector3().subVectors(camera.position, z.mesh.position).setY(0).normalize();
                    z.mesh.position.add(v.multiplyScalar(z.speed));

                    if(z.mesh.position.distanceTo(camera.position) < 1.5) {
                        player.hp -= 0.5;
                        document.getElementById('hp-bar').style.width = player.hp + "%";
                        if(player.hp <= 0) location.reload();
                    }
                });
            }
            renderer.render(scene, camera);
        }

        spawnWave(); animate();
    </script>
</body>
</html>
